#!/bin/bash

. /etc/profile
kill -9 $(ps aux | grep CassandraDaemon | grep -v grep | awk 'NR == 1' | awk {'print $2'})

cd /mnt/ssd/CassandraEC
git checkout yuanming
git pull origin yuanming

my_ip=$(ifconfig eth0 | grep 'inet ' | awk '{print $2}')
echo "my_ip: ${my_ip}"
last_octet=$(echo $my_ip | awk -F'.' '{print $NF}')
echo "last_octet: ${last_octet}"
tokens=(-9223372036854775808 -7378697629483820544 -5534023222112865280 -3689348814741909504 -1844674407370954752 0 1844674407370956800 3689348814741911552 5534023222112866304 7378697629483821056)
tokens20=(-9223372036854775808 -8301034833169298176 -7378697629483820544 -6456360425798342656 -5534023222112865280 -4611686018427387904 -3689348814741909504 -2767011611056432128 -1844674407370954752 -922337203685477376 0 922337203685478400 1844674407370956800 2767011611056433152 3689348814741911552 4611686018427387904 5534023222112866304 6456360425798344704 7378697629483821056 8301034833169299456)
tokens30=(-9223372036854775808 -8608480567731124096 -7993589098607472384 -7378697629483820544 -6763806160360168960 -6148914691236517376 -5534023222112865280 -4919131752989213696 -4304240283865562112 -3689348814741910528 -3074457345618258944 -2459565876494607360 -1844674407370954752 -1229782938247303168 -614891469123651584 0 614891469123651584 1229782938247303168 1844674407370954752 2459565876494606336 3074457345618257920 3689348814741909504 4304240283865561088 4919131752989212672 5534023222112866304 6148914691236517888 6763806160360169472 7378697629483821056 7993589098607472640 8608480567731124224)
tokens40=(-9223372036854775808 -8762203435012036992 -8301034833169298176 -7839866231326559232 -7378697629483820544 -6917529027641081856 -6456360425798342656 -5995191823955603968 -5534023222112865280 -5072854620270126592 -4611686018427387904 -4150517416584648704 -3689348814741909504 -3228180212899171328 -2767011611056432128 -2305843009213693952 -1844674407370954752 -1383505805528215552 -922337203685477376 -461168601842738176 0 461168601842739200 922337203685478400 1383505805528217600 1844674407370956800 2305843009213693952 2767011611056433152 3228180212899172352 3689348814741911552 4150517416584650752 4611686018427387904 5072854620270127104 5534023222112866304 5995191823955605504 6456360425798344704 6917529027641081856 7378697629483821056 7839866231326560256 8301034833169299456 8762203435012038656)

# tokens=${tokens10}
# echo ${token}
# exit
selected_token=${tokens[(( last_octet - 1))]}
echo "selected_token: ${selected_token}"
sed -i "s/initial_token:.*$/initial_token: ${selected_token}/" /home/elect/elect.yaml
sed -i "s/rpc_address:.*$/rpc_address: ${my_ip}/" /home/elect/elect.yaml
sed -i "s/listen_address:.*$/listen_address: ${my_ip}/" /home/elect/elect.yaml

cp /home/elect/elect.yaml conf/cassandra.yaml

rm -rf data logs
mkdir -p data/receivedParityHashes/
mkdir -p data/localParityHashes/
mkdir -p data/ECMetadata/
mkdir -p data/tmp/
mkdir -p logs
ant realclean && ant -Duse.jdk11=true

cd src/native/src/org/apache/cassandra/io/erasurecode/
./genlib.sh
rm -rf /mnt/ssd/CassandraEC/lib/sigar-bin/libec.so
cd /mnt/ssd/CassandraEC
cp src/native/src/org/apache/cassandra/io/erasurecode/libec.so lib/sigar-bin

